{#
    portal/search_results.html
    ~~~~~~~~~~~~~~~~~~~~~~~~~~

    This page displays the search results.

    :copyright: 2007 - 2008 by Benjamin Wiegand.
    :license: GNU GPL.
#}

{%- extends 'portal/overall.html' %}
{% from 'macros.html' import render_form %}
{% set navi_type = 'tabbar' %}
{% set styles = ['datetimefield.css'] %}
{% set scripts = ['DateTime.js'] %}
{% set title = 'Suche' %}
{% set active_app = area %}
{% set deny_robots = 'noindex' %}

{% block appheader %}
  <h1><a href="{{ href('portal', 'search') }}">Suche</a></h1>
  <h2>Ergebnisse für „{{ query|e }}“</h2>
{% endblock %}

{% block portal_content %}
  <h3>Suche</h3>
  <p>Hier kannst du nach Informationen im gesamten ubuntuusers Portal suchen.
  Die Suche berücksichtigt keine Groß- und Kleinschreibung und mehrere
  Suchausdrücke können mit <strong>UND</strong>, <strong>ODER</strong> sowie
  <strong>UND&nbsp;NICHT</strong> kombiniert werden, wobei gegebenenfalls
  eine Klammer zu setzen ist.  Weitere Informationen zur Suche auf ubuntuusers.de findet man im Wiki unter <a href="{{ href('wiki', 'Suchfunktion') }}">Suchfunktion</a>.</p>
  <form action="{{ href('portal', 'search') }}" method="GET" class="search_page">
    <p>{{ searchform.query }}</p>
    <input type="submit" value="Suchen" style="display: none;" />
    <div class="submit">
      {%- if not advanced %}
      <input type="submit" id="expand" name="advanced" value=Erweitert />
      {%- endif %}
      <input type="submit" value="Suchen" />
    </div>
    {{ searchform.area }}
    <br style="clear: both;" />
    <div id="advanced"{% if advanced %} style="display: block;"{% endif %}>
      <dl>
        <dt><label for="id_date_begin">Zeitraum:</label></dt>
        <dd>{{ searchform.date_begin }}<span> bis </span>{{ searchform.date_end }}<br />
          <span class="help_text">z.B. <code>2008-12-31</code> oder
          <code>2008-12-31 17:00</code></span></dd>
        <dt>{{ searchform.sort.label_tag() }}</dt><dd>{{ searchform.sort }}</dd>
      </dl>
      {%- if not (advanced and area not in ('all', 'forum')) %}
      <dl class="search_fields" id="forum_fields">
        {{ render_form(searchform, ['forums'], inline=true) }}
      </dl>
      {%- endif %}
      {%- if not (advanced and area not in ('all', 'wiki')) %}
      <dl class="search_fields" id="wiki_fields">
        {{ render_form(searchform, ['show_wiki_attachments'], inline=true) }}
      </dl>
      {%- endif %}
    </div>
  </form>
  <script>

{#
  var ajax_search = function() {
      $('div.search_results').html($('<strong style="text-align: center;">Lade Suchergebnisse...</strong>'));

      // form data
      var queryString = $.trim($('form.search_page input[name="query"]').val());
      var area = $.trim($('form.search_page input[type=radio]:checked').val());
      var date_begin = $.trim($('form.search_page input[name="date_begin"]').val());
      var date_end = $.trim($('form.search_page input[name="date_end"]').val());
      var sort = $.trim($('form.search_page select[name="sort"] option:selected').val());
      var forums = $.trim($('form.search_page select[name="forums"] option:selected').val());

      // If the query string is non-empty,
      if (queryString.length) {
          // Submit GET request to the URL matching the route named 'search_query'
          var values = {
              'query': queryString,
              'area': area,
              'date_begin': date_begin,
              'date_end': date_end,
              'sort': sort,
              'forums': forums
          };
          $('div.search_results').load("{{ href('portal', 'search') }} div.search_results", values, function(data) {
            // TODO: Set new url of the search!
          });
      }
      return false;
  }
#}
  $(document).ready(function() {

    $('#expand').click(function() {
      $(this).hide();
      $('#advanced').show();
      return false;
    });

    $('input[name="area"]').each(function(i, elm) {
      $(this).change(function() {
        change_area($(this).val());
      })
    });

    function change_area(id) {
      if (id != 'all') {
        $('dl.search_fields').hide();
        $('#' + id + '_fields').show();
      } else {
        $('dl.search_fields').show();
      }
    }
    change_area('{{ area }}');

{#
    $('input[name="advanced"]').click(ajax_search);

    // TODO: Add more features like spell-suggestions here.
    $('input[name="query"]').keydown(function(event) {
      switch(event.keyCode) {
        // RETURN key
        case 13:
          ajax_search();
          break;
      };
    }).focus();
#}
  });

  </script>
  <hr class="divider" />
  <div class="search_results">
  {%- if query %}
  {% if results.results %}{{ pagination }}{% endif %}
  <ul class="search_results">
    {%- for doc in results.results if not doc.hidden %}
    <li>
      <h2>
        <img src="{{ href('static', 'img/icons/small/%s.png' % doc.component|lower) }}"
          alt="{{ doc.component }}" title="{{ doc.component }}" />
        <a href="{{ doc.url }}{% if doc.highlight and highlight %}?highlight={{ highlight|urlencode|e }}{% endif %}">
          {{ doc.title }}
        </a>
        {%- if doc.solved %}
        <img src="{{ href('static', 'img/check.png') }}" alt="Gelöst" title="Gelöst" />
        {%- endif %}
        {%- if doc.version %}
        <span class="ubuntu_version">{{ doc.version }}</span>
        {%- endif %}
      </h2>
      <p class="description">
        {{ doc.excerpt }}
      </p>
      <p class="meta">
        {%- if doc.component in ('Forum', 'Ikhaya', 'Planet') %}
        geschrieben von <a href="{{ doc.user_url }}">{{ doc.user|e }}</a> am {{ doc.date|specificdatetimeformat|e }}{% if not doc.component in ('Planet',) %} in <a href="{{ doc.group_url }}">{{ doc.group|e }}</a>{% endif %}
        {%- elif doc.component == 'Wiki' %}
        zuletzt bearbeitet von <a href="{{ doc.user_url }}">{{ doc.user.username|e }}</a> am {{ doc.date|specificdatetimeformat }}
        {%- endif %}
        {%- if doc.component == 'Forum' %}
        <a href="{{ doc.last_post_url }}" alt="Springe zu letztem Beitrag"><img src="{{ href('static', 'img/forum/goto.png') }}" /></a>
        {%- endif %}
      </p>
    </li>
    {%- else %}
    <li class="no_results">Es wurden keine passenden Ergebnisse gefunden.</li>
    {%- endfor %}
  </ul>
  <br />
  {% if results.results %}{{ pagination }}{% endif %}
  <br clear="both" />
  {%- endif %}
  </div>
{% endblock %}
