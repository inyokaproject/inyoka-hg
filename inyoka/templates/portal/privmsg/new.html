{#
    portal/privmsg/new.html
    ~~~~~~~~~~~~~~~~~~~~~~~

    Template for writing and sending new private messages.

    :copyright: 2007 by Christoph Hack, Benjamin Wiegand.
    :license: GNU GPL.
#}
{%- extends 'portal/privmsg/overall.html' %}
{% from 'macros.html' import render_form %}
{% set styles = ['editor.css'] %}
{% set scripts = ['WikiEditor.js', 'jQuery.autocomplete.js'] %}
{% set title_trace = ['Neue Nachricht'] %}
{% set selected = 'new' %}

{% block portal_content %}
  <form action="{{ href('portal', 'privmsg', 'new') }}" method="post">
    {{ form.non_field_errors() }}
    {% if USER.can('send_group_pm') %}
    {{ render_form(form, ['recipient', 'group_recipient','subject', 'text']) }}
    {% else %}
    {{ render_form(form, ['recipient', 'subject', 'text']) }}
    {% endif %}
    <p>
      <input type="submit" name="preview" value="Vorschau" />
      <input type="submit" value="Nachricht absenden" />
    </p>
  </form>
  {%- if preview %}
  <div class="preview_wrapper">
    <h2 class="title">Vorschau</h2>
    <div id="preview" class="preview">{{ preview }}</div>
  </div>
  {%- endif %}
  <script type="text/javascript">
    /* <![CDATA[ */
    var text = new WikiEditor('textarea[@name="text"]', 'forum');
    (function() {
      var
        editor = $('textarea[@name="text"]'),
        output = $('<div class="preview" />')
      var preview = $('<div class="preview_wrapper" />')
        .hide()
        .append('<h2 class="title">Vorschau<\/h2>')
        .append(output);

      $('form input[@name="preview"]').click(function() {
        $('body, input, textarea').css('cursor', 'progress');
        preview.hide();
        $.post('/?__service__=wiki.render_preview', {
          text: editor.val()
        }, function(data) {
          output.html(data);
          preview.slideDown('fast');
          $('body, input, textarea').css('cursor', 'auto');
        });
        return false;
      }).parent().parent().parent().append(preview);
    })();
    (function() {
        search_field = $('<span class="usersearch"> Suche: </span>')
            .append($('<input type="text" id="privmsg_search_user" />').autocomplete("/?__service__=admin.get_user_autocompletion", {
                delay: 40, maxItemsToShow: 15, cacheLength: 10}))
            .append($(' <input style="margin-left: 1ex" type="button" value="Hinzufügen" />').click(function () {
                sep = ""
                if( $('#id_recipient').val() != "" ) {
                    sep = "; "
                }
                $('#id_recipient').val(
                    $('#id_recipient').val()
                    + sep + $('#privmsg_search_user').val());
                $('#privmsg_search_user').val("");
            }));
        search_link = $('<a style="text-decoration: none; padding-left: 1ex;" id="privmsg_search_user_link">Suchen…</a>').click(function () {
            $('#privmsg_search_user_link').after(search_field);
            $('#privmsg_search_user_link').remove();
        });
        $("#id_recipient").after(search_link);
    })();
    /* ]]> */
  </script>
{% endblock %}
