{#
    forum/topic.html
    ~~~~~~~~~~~~~~~~

    This page shows a single topic.
    It displays the posts and some informations about their authors.
    It is "paginated".

    :copyright: 2007 by Maximilian Trescher, Benjamin Wiegand.
    :license GNU GPL
    
#}
{% extends 'forum/page.html' %}

{% set title_trace = [topic.title|e] %}
{% set name = 'Thema „%s“ - ' % topic.title|e %}
{% set feeds = [
  (name ~ 'Nur Überschrift', href('forum', 'feeds/topic', topic.slug, 'title/20')),
  (name ~ 'Nur Einleitung', href('forum', 'feeds/topic', topic.slug, 'short/20')),
  (name ~ 'Ganzer Beitrag', href('forum', 'feeds/topic', topic.slug, 'full/20'))
] %}
{% for parent in forum.parents %}
  {% set navigation_trace = navigation_trace + [(parent|url, parent.name)] ! %}
{% endfor %}
{% set navigation_trace = navigation_trace + [
    (forum|url, forum.name),
    (topic|url, topic.title)
  ] %}

{% macro topic_actions %}
  <span class="linklist">
    <a href="{{ topic|url('reply') }}" class="action action_reply">antworten</a> |
    {%- if is_subscribed %}
    <a href="{{ topic|url('unsubscribe') }}" class="action action_subscribe">de-abonnieren</a> |
    {%- else %}
    <a href="{{ topic|url('subscribe') }}" class="action action_subscribe">abonnieren</a> |
    {%- endif %}
    {%- if topic.solved %}
    <a href="{{ topic|url('unsolve') }}" class="action action_unsolve">als ungelöst markieren</a> |
    {%- else %}
    <a href="{{ topic|url('solve') }}" class="action action_solve">als gelöst markieren</a> |
    {%- endif %}
    <a href="{{ topic|url('report') }}" class="action action_report">melden</a>
  </span>
{% endmacro %}

{% block forum_content %}
  <div class="topic_box">
    <h2>{{ topic.title|e }}</h2>
    <div class="topic_box_content">
      {{ pagination.generate('right') }}
      <strong>Status:</strong> <span class="status_{{
        topic.solved and 'solved' or 'unsolved' }}">{{
        topic.solved and 'gelöst' or 'ungelöst' }}</span>
      <span class="linklist">|</span>
      <strong>Ubuntu-Version:</strong>
        {{ topic.get_ubuntu_version() }}<br />
        {{ topic_actions() }}
      </div>
    </div>

  {%- if polls %}
  <form action="" method="post" class="poll">
    {%- for poll in polls %}
    <div><strong>{{ poll.question|e }}</strong></div>
    <table class="poll">
      {%- for option in poll.options %}
      <tr>
        <td>
          {%- if not poll.participated and not show_vote_results %}
          <input type="{{ poll.multiple_votes and 'checkbox' or 'radio' }}"
                 name="poll_{{ poll.id }}" id="poll_{{ poll.id }}"
                 value="{{ option.id }}" />
          <label for="poll_{{ option.id }}">{{ option.name|e }}</label>
          {%- else %}
          {{ option.name|e }}
          {%- endif %}
        </td>
        {%- if poll.participated or show_vote_results %}
        <td class="vote_bar"><div style="width: {{ option.percentage * 2 }}px;"></div></td>
        <td>{{ option.percentage }}%</td>
        <td>[ {{ option.votes }} ]</td>
        {%- endif %}
      </tr>
      {%- endfor %}
    </table>
    {%- endfor %}
    {%- if can_vote %}
    <p>
      <input type="submit" name="vote" value="Abstimmen" />
      {%- if show_vote_results %}
      <a href="?">Ergebnisse verbergen</a>
      {%- else %}
      <a href="?action=vote_results">Ergebnisse anzeigen</a>
      {%- endif %}
    </p>
    {%- endif %}
  </form>
  {%- endif %}

  <table class="topic">
   <tbody>
    {%- for post in posts %}
      {% if post.hidden and not check_privilege(privileges, 'moderate') %}
      <tr class="deleted">
        <td colspan="2">Dieser Beitrag wurde von einem Moderator gelöscht.</td>
      </tr>
      {%- else %}
      {%- set attachments = post.attachments %}      
      <tr id="post-{{ post.id }}"{% if post.hidden %} class="hidden"{% endif %}>
        <td class="author">
          <p class="username"><a href="{{ post.author|url }}">{{ post.author.username|e }}</a></p>
          {%- if post.author.avatar and not USER.settings['hide_avatars'] %}
          <img class="avatar" src="{{ post.author.avatar_url }}" alt="Avatar von {{ post.author.username|e }}" />
          {%- endif %}
          <p>Anmeldungsdatum: {{ post.author.date_joined|dateformat }}</p>
          <p>Beiträge: {{ post.author.post_count }}</p>
          {%- if post.author.location %}
          <p>Wohnort: {{ post.author.location|e }}</p>
          {%- endif %}
        </td>
        <td class="post">
          <div class="postinfo">
            <div class="linklist floatright">
              <a href="{{ post|url('edit') }}" class="action action_edit">bearbeiten</a> |
              <a href="{{ post|url('quote') }}" class="action action_quote">zitieren</a>
              {%- if check_privilege(privileges, 'moderate') %} |
                {%- if post.hidden %}
                <a href="{{ post|url('restore') }}" class="action action_restore">wiederherstellen</a> |
                <a href="{{ post|url('delete') }}" class="action action_delete">endgültig löschen</a>
                {%- else %}
                <a href="{{ post|url('hide') }}" class="action action_hide">verbergen</a>
                {%- endif %}
              {%- endif %}
            </div>
            <a href="{{ post|url }}" title="Kopiere diesen Link, um auf diesen Beitrag zu verweisen" onclick="alert(this.title); return false"><img src="{{ href('static', 'img', 'icon_minipost.gif') }}" alt="Beitrag" /></a>
            Verfasst: {{ post.pub_date|datetimeformat }}
          </div>
          {{ post.rendered_text }}
          {{ h.render_attachments(attachments) }}
          {%- if post.author.signature and not USER.settings['hide_signatures'] %}
            <div class="signature">
            {{ post.author.rendered_signature }}
            </div>
          {%- endif %}
        </td>
      </tr>
      {%- endif %}
    {%- endfor %}
    </tbody>
  </table>
  
  <div class="topic_box">
    <div class="topic_box_content">
      {{ pagination.generate('right') }}
      {{ topic_actions() }}<br />
      {% if check_privilege(privileges, 'moderate') %}
      <span class="linklist">
        <a href="{{ topic|url('split') }}" class="action action_split">aufteilen</a> | 
        <a href="{{ topic|url('move') }}" class="action action_move">verschieben</a> | 
        {%- if topic.locked %}
        <a href="{{ topic|url('unlock') }}" class="action action_unlock">entsperren</a> | 
        {%- else %}
        <a href="{{ topic|url('lock') }}" class="action action_lock">sperren</a> |
        {%- endif %}
        {%- if topic.hidden %}
        <a href="{{ topic|url('restore') }}" class="action action_restore">wiederherstellen</a> |
        <a href="{{ topic|url('delete') }}" class="action action_delete">löschen</a>
        {%- else %}
        <a href="{{ topic|url('hide') }}" class="action action_hide">verbergen</a> 
        {%- endif %}
      </span>
      {% endif %}
    </div>
  </div>
      <div class="pathbar">
        <p class="trace">{%- for link, title in [(href('portal'), 'ubuntuusers.de')] +
          navigation_trace %}
          <a href="{{ link|e }}">{{ title|e }}</a>{% if not loop.last
            %} »{% endif %}
        {%- endfor %}</p>
        <div style="clear:both;"></div>
      </div>{# .pathbar #}
{% endblock %}
