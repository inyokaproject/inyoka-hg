{#
    forum/forum.html
    ~~~~~~~~~~~~~~~~

    This template shows a forum with all subforums and topics inside.

    :copyright: 2007 by Benjamin Wiegand.
    :license: GNU GPL.
#}
{%- extends 'forum/page.html' %}
{% from 'forum/_forum.html' import render_forum, topic_icon with context %}

{% set title_trace = [forum.name|e] %}
{% set name = 'Forum „%s“ - ' % forum.name|e %}
{% set feeds = [
  (name + 'Nur Überschrift', href('forum', 'feeds/forum', forum.slug, 'title/20')),
  (name + 'Nur Einleitung', href('forum', 'feeds/forum', forum.slug, 'short/20')),
  (name + 'Ganzer Beitrag', href('forum', 'feeds/forum', forum.slug, 'full/20'))
] %}
{% set navigation_trace = [] %}
{% for parent in forum.parents %}
  {% do navigation_trace.append([parent|url, parent.name]) %}
{% endfor %}
{% do navigation_trace.append([forum|url, forum.name]) %}

{% block search_areas %}
  <option value="current_forum" selected="selected">Dieses Forum</option>
{% endblock %}

{% block forum_content %}
  <table class="forum">
    <thead>
      <tr><th colspan="5" class="category">{{ forum.name|e }}</th></tr>
      <tr>
        <td colspan="5">
          {%- if forum.description %}
          <p class="description">{{ forum.description|e }}</p>
          {%- endif %}
          {{ pagination_right }}
          <p class="actions">
            <a href="{{ forum|url('newtopic') }}">Neues Thema</a> | 
            {%- if is_subscribed %}
            <a href="{{ forum|url('unsubscribe') }}" class="action action_subscribe">abbestellen</a>
            {%- else %}
            <a href="{{ forum|url('subscribe') }}" class="action action_subscribe">abonnieren</a>
            {%- endif %}
          </p>
        </td>
      </tr>
    </thead>
    <tbody>
    {%- for subforum in subforums %}
      {{ render_forum(subforum) }}
    {%- endfor %}
    <tr>
      <th class="topic" colspan="2">Thema</th>
      <th class="view_count">Aufrufe</th>
      <th class="post_count">Antworten</th>
      <th class="last_post">Letzter Beitrag</th>
    </tr>
    {%- for row in rows %}
      {%- if row.topic_hidden and not can_moderate %}
      <tr class="deleted">
        <td class="icon">
          <img src="{{ href('static', 'img', 'forum', 'topic-deleted.png') }}" alt="" />
        </td>
        <td colspan="5">
          Dieses Thema wurde von einem Moderator gelöscht.
        </td>
      </tr>
      {%- else %}
      <tr{% if row.topic_hidden or row.topic_reported %} class="{% if row.topic_hidden %}hidden {% endif %}{% if row.topic_reported %}reported{% endif %}"{% endif %}>
        <td class="icon">
          {{ topic_icon(row) }}
        </td>
        <td class="topic">
          <p class="topic_title">
            {%- if row.topic_sticky %}<strong>Wichtig: </strong>{% endif -%}
            {%- if row.topic_has_poll %} <strong>[Umfrage]</strong> {% endif -%}
            {%- if row.topic_hidden %} [Verborgen] {% endif -%}
            {%- if row.topic_reported %} [Gemeldet] {% endif -%}
            <a href="{{ href('forum', 'topic', row.topic_slug) }}">{{- row.topic_title|e -}}</a>
          </p>
          <p class="description">
            von <a href="{{ href('portal', 'user', row.author_username) }}">{{ row.author_username|e }}</a>
            {%- if row.topic_paginated %} &#160; &#160; [
              Gehe zu Seite {{ row.topic_get_pagination() }}
            ]{% endif -%}
          </p>
        </td>
        <td class="view_count">{{ row.topic_view_count }}</td>
        <td class="post_count">{{ row.topic_post_count - 1 }}</td>
        <td class="last_post">{% if row.last_post_id %}
          <a href="{{ href('forum', 'post', row.last_post_id) }}" class="date">{{
              row.last_post_pub_date|datetimeformat }}</a><br />
          von <a href="{ row.last_post.author|url}}">{ row.last_post.author }}</a>
        {%- else %}---{% endif %}</td>
      </tr>
      {%- endif %}
    {% else %}
      <tr>
        <td colspan="5">
          Es existieren noch keine Themen. <a href="{{ forum|url('newtopic') }}">Erstelle</a> doch das Erste!</td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
  <div class="forum_offset_pagination">
    {{ pagination_left }}
  </div>
{% endblock %}
