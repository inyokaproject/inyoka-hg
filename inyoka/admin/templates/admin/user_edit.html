{#
    admin/edit_user.html
    ~~~~~~~~~~~~~~~~~~~~

    Just edit an user...

    :copyright: (c) 2007-2010 by the Inyoka Team, see AUTHORS for more details.
    :license: GNU GPL, see LICENSE for more details.
#}
{%- extends 'admin/overall.html' %}
{% from 'macros.html' import render_form %}
{% set styles = ['editor-sprite.css', 'datetimefield.css'] %}
{% set scripts = ['WikiEditor.min.js', 'DateTime.min.js', 'PrivilegeBox.min.js', 'UserGroupBox.min.js'] %}

{% set navigation_trace = [
    (href('admin', 'users'), 'Benutzer'),
    (href('admin', 'users', 'edit', user.username), 'Benutzer „%s“ editieren'|format(user.username|e))
] %}

{% block appheader %}
<h1><a href="{{ href('admin') }}">Administration</a></h1>
<h2><a href="{{ href('admin', 'users') }}">Benutzer</a></h2>
{% endblock %}


{% block admin_content %}
<form enctype="multipart/form-data" id="user_edit_form" method="post" action="">
  <h3>Benutzer bearbeiten</h3>
  <dl>
    {{ render_form(form, ['username'], inline=true) }}
    <dt>{{ form.status.label }}</dt>
    <dd>{{ form.status }} {{ form.errors.status }}<br />
      <span class="note">
        Der Benutzer hat sich {{ user.last_login|specificdatetimeformat(true) }} das letzte Mal eingeloggt.
      </span>
      <div class="note">
        {{ user.username }} eine <a href="{{ href('admin', 'users', 'mail', user.username, next=CURRENT_URL) }}">E-Mail schreiben</a>.
      </div>
      {%- if activation_link %}
      <div class="note"><a href="{{ href('admin', 'users', 'resend_activation_mail', user=user, next=CURRENT_URL) }}">Aktivierungsmail erneut senden.</a></div>
      <div class="note">Aktivierungslink: <a href="{{ activation_link }}">{{ activation_link }}</a></div>
      {%- endif %}
    </dd>
    <dt>{{ form.member_title.label }}</dt>
    <dd>{{ form.member_title }}{% if joined_groups %} 
      <div class="group_titles">
      {% for group in joined_groups %}
        <input type="checkbox" name="group_titles" value="{{ group }}" /> {{ group }}
      {% endfor %}
      </div>
    {%- endif %}</dd>
    {{ render_form(form, ['new_password', 'confirm_password', 'email', 'banned_until'], inline=true) }}
    {#    <dd class="note_link bann_user_event">
      Benutzer sperren
      </dd>#}
    <dt>Gruppenzugehörigkeiten editieren:</dt>
    <dd>
      <table class="user_groups">
        <tr>
          <th>nicht zugehörige Gruppen</th>
          <th class="actions">
            <img src="{{ href('static', 'img/admin/add_item.png') }}" alt="Gruppen hinzufügen" class="item_add" />
            <img src="{{ href('static', 'img/admin/remove_item.png') }}" alt="Gruppen entfernen" class="item_remove" />
          </th>
          <th>zugehörige Gruppen</th>
        </tr>
        <tr>
          <td><select multiple="multiple" size="5" name="user_groups_not_joined"></select></td>
          <td></td>
          <td><select multiple="multiple" size="5" name="user_groups_joined"></select></td>
        </tr>
      </table>
    </dd>
    <dt>{{ form.primary_group.label }}</dt>
    <dd>
      {{ form.primary_group }} <a href="" class="delete_primary_group">löschen</a>
      <p class="note">{{ form.primary_group.help_text }}</p>
    </dd>
    <dt>Privilegien</dt>
    <dd>
      {%- for id, name, checked, derived in permissions %}
      <input type="checkbox" name="permissions" value="{{ id }}" id="perm_{{ id }}"
             {%- if checked %} checked="checked"{% endif %} />
      <label for="perm_{{ id }}">{{ name|e }}</label>
      {%- if derived %}<span class="note"> (Geerbt von {% for group in derived %}<a href="{{ group|url }}">{{ group.name|e }}</a>{% if not loop.last %}, {% endif %}</span>{% endfor %})
      {%- endif -%}
      <br />
      {%- endfor %}
      {{ form.permissions.errors }}
    </dd>
    <dt>Forum-Privilegien:</dt>
    <dd id="forum_rights">Javascript muss aktiviert sein, um die Privilegien zu editieren!</dd>
    {{ render_form(form, ['date_joined'], inline=true) }}
    <dd class="note_link date_joined_ui_switcher">grafischen Editor aktivieren</dd>
  </dl>
  <h3>Persönliche Details von {{ user.username|e }}</h3>
  {{ render_form(form, ['website', 'launchpad', 'interests', 'location']) }}
  <h3>Benachrichtigungs-Einstellungen</h3>
  {{ render_form(form, ['jabber', 'icq', 'msn', 'aim', 'yim', 'skype', 'wengophone', 'sip']) }}
  <h3>Sonstige Einstellungen</h3>
  <dl>
  {{ render_form(form, ['signature', 'coordinates_long', 'coordinates_lat'], inline=true) }}
  <dt>{{ form.avatar.label }}</dt>
  <dd>{{ form.avatar }} <span>{{ form.delete_avatar }} {{ form.delete_avatar.label }}</span>
    <p class="note">(Wird auf {{ avatar_height }}x{{ avatar_width }} skaliert)</p></dd>
  {{ render_form(form, ['gpgkey']) }}
  <p>
    <input type="submit" value="Speichern" />
  </p>
</form>
<script type="text/javascript">
  /* <![CDATA[ */
  var signature = new WikiEditor('textarea[name="signature"]');
  var forum_rights = new PrivilegeBox('#forum_rights', {{ user_forum_privileges|jsonencode }},
    {{ forum_privileges|jsonencode }});
  var select_form = new GroupBox('#user_edit_box',
    {{ joined_groups|sort|jsonencode }},
    {{ not_joined_groups|sort|jsonencode }}
  );

  var date_joined = null;
  var dj_ui_switcher = $('.date_joined_ui_switcher')
    .click(function() {
      if (date_joined instanceof DateTimeField) {
        date_joined.destroy();
        date_joined = null;
        dj_ui_switcher.text('grafischen Editor aktivieren');
      } else {
        date_joined = new DateTimeField('input[name="date_joined"]');
        dj_ui_switcher.text('grafischen Editor deaktivieren');
      }
    });

  $('input[name="group_titles"]').change(function() {
    var value = "";
    $('input[name="group_titles"]:checked').each(function(i) {
      if (i>0) value += " & ";
      value += $(this).val();
    });
    $('#id_member_title').val(value);
  });

  $('select[name="user_groups_joined"]').change(function() {
    var field = $('select[name="user_groups_joined"]');
    $('input[name="primary_group"]').val(field.find('option:selected').val());
  });

  $('a.delete_primary_group').click(function() {
    $('input[name="primary_group"]').val("");
    return false;
  });
  /* ]]> */
</script>
{% endblock %}
